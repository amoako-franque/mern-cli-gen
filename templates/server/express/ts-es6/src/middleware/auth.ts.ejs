import { Request, Response, NextFunction } from 'express';
<% if (auth==='jwt' ) { %>
    import jwt from 'jsonwebtoken';
    <% } %>
        <% if (database==='mongodb' ) { %>
            import User from '../models/User';
            <% } else { %>
                import { UserModel as User } from '../models/User';
                <% } %>

                    export const protect = async (req: Request, res: Response, next: NextFunction) => {
                    let token;

                    <% if (auth==='jwt' ) { %>
                        if (req.headers.authorization && req.headers.authorization.startsWith('Bearer')) {
                        token = req.headers.authorization.split(' ')[1];
                        }

                        if (!token) {
                        return res.status(401).json({ message: 'Not authorized, no token' });
                        }

                        try {
                        const decoded: any = jwt.verify(token, process.env.JWT_SECRET || 'secret');
                        <% if (database==='mongodb' ) { %>
                            (req as any).user = await User.findById(decoded.id).select('-password');
                            <% } else { %>
                                (req as any).user = await User.findById(decoded.id);
                                <% } %>
                                    next();
                                    } catch (error) {
                                    res.status(401).json({ message: 'Not authorized, token failed' });
                                    }

                                    <% } else { %>
                                        // Session auth
                                        if (!(req as any).session || !(req as any).session.userId) {
                                        return res.status(401).json({ message: 'Not authorized, please login' });
                                        }

                                        try {
                                        <% if (database==='mongodb' ) { %>
                                            (req as any).user = await User.findById((req as
                                            any).session.userId).select('-password');
                                            <% } else { %>
                                                (req as any).user = await User.findById((req as any).session.userId);
                                                <% } %>
                                                    next();
                                                    } catch (error) {
                                                    res.status(401).json({ message: 'Not authorized' });
                                                    }
                                                    <% } %>
                                                        };