const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const morgan = require('morgan');
const { router } = require('./routes/index');
const { errorHandler } = require('./middleware/errorHandler');
<% if (auth==='session' || auth==='passport' ) { %>
    const session = require('express-session');
    <% if (auth==='passport' ) { %>
        const passport = require('passport');
        const { configurePassport } = require('./config/passport');
        <% } %>
            <% if (database==='mongodb' ) { %>
                const MongoStore = require('connect-mongo');
                <% } else if (database==='postgresql' ) { %>
                    const pgSession = require('connect-pg-simple');
                    const { pool } = require('./config/db');
                    const PgStore = pgSession(session);
                    <% } %>
                        <% } %>

                            const app = express();

                            // Middleware
                            app.use(helmet());
                            app.use(cors());
                            app.use(morgan('dev'));
                            app.use(express.json());
                            app.use(express.urlencoded({ extended: true }));

                            <% if (auth==='session' || auth==='passport' ) { %>
                                // Session configuration
                                app.use(session({
                                secret: process.env.SESSION_SECRET || 'secret',
                                resave: false,
                                saveUninitialized: false,
                                cookie: {
                                secure: process.env.NODE_ENV === 'production',
                                maxAge: 30 * 24 * 60 * 60 * 1000 // 30 days
                                },
                                <% if (database==='mongodb' ) { %>
                                    store: MongoStore.create({
                                    mongoUrl: process.env.MONGODB_URI || 'mongodb://localhost:27017/<%= projectName %>'
                                        })
                                        <% } else if (database==='postgresql' ) { %>
                                            store: new PgStore({
                                            pool,
                                            tableName: 'session',
                                            createTableIfMissing: true
                                            })
                                            <% } %>
                                                }));

                                                <% if (auth==='passport' ) { %>
                                                    // Passport configuration
                                                    configurePassport();
                                                    app.use(passport.initialize());
                                                    app.use(passport.session());
                                                    <% } %>
                                                        <% } %>

                                                            // Routes
                                                            app.use('/api', router);

                                                            // Error handling
                                                            app.use(errorHandler);

                                                            module.exports = app;