<% if (auth==='jwt' ) { %>
    import jwt from 'jsonwebtoken';
    <% } %>
        <% if (database==='mongodb' ) { %>
            import User from '../models/User.js';
            <% } else { %>
                import { UserModel as User } from '../models/User.js';
                <% } %>

                    export const protect = async (req, res, next) => {
                    let token;

                    <% if (auth==='jwt' ) { %>
                        if (req.headers.authorization && req.headers.authorization.startsWith('Bearer')) {
                        token = req.headers.authorization.split(' ')[1];
                        }

                        if (!token) {
                        return res.status(401).json({ message: 'Not authorized, no token' });
                        }

                        try {
                        const decoded = jwt.verify(token, process.env.JWT_SECRET || 'secret');
                        <% if (database==='mongodb' ) { %>
                            req.user = await User.findById(decoded.id).select('-password');
                            <% } else { %>
                                req.user = await User.findById(decoded.id);
                                <% } %>
                                    next();
                                    } catch (error) {
                                    res.status(401).json({ message: 'Not authorized, token failed' });
                                    }

                                    <% } else { %>
                                        // Session auth
                                        if (!req.session || !req.session.userId) {
                                        return res.status(401).json({ message: 'Not authorized, please login' });
                                        }

                                        try {
                                        <% if (database==='mongodb' ) { %>
                                            req.user = await User.findById(req.session.userId).select('-password');
                                            <% } else { %>
                                                req.user = await User.findById(req.session.userId);
                                                <% } %>
                                                    next();
                                                    } catch (error) {
                                                    res.status(401).json({ message: 'Not authorized' });
                                                    }
                                                    <% } %>
                                                        };