<% if (auth==='passport' ) { %>
    import passport from 'passport';
    import { Strategy as LocalStrategy } from 'passport-local';
    import { Strategy as GoogleStrategy } from 'passport-google-oauth20';
    import { Strategy as GitHubStrategy } from 'passport-github2';
    <% if (database==='mongodb' ) { %>
        import User from '../models/User.js';
        <% } else { %>
            import { UserModel as User } from '../models/User.js';
            <% } %>

                export const configurePassport = () => {
                // Session Serialization
                passport.serializeUser((user, done) => {
                done(null, user.id || user._id);
                });

                passport.deserializeUser(async (id, done) => {
                try {
                const user = await User.findById(id);
                done(null, user);
                } catch (err) {
                done(err, null);
                }
                });

                // Local Strategy
                passport.use(new LocalStrategy(
                { usernameField: 'email' },
                async (email, password, done) => {
                try {
                <% if (database==='mongodb' ) { %>
                    const user = await User.findOne({ email }).select('+password');
                    if (!user) return done(null, false, { message: 'Incorrect email.' });
                    const isMatch = await user.comparePassword(password);
                    <% } else { %>
                        const user = await User.findByEmail(email);
                        if (!user) return done(null, false, { message: 'Incorrect email.' });
                        const isMatch = await User.comparePassword(password, user.password);
                        <% } %>

                            if (!isMatch) return done(null, false, { message: 'Incorrect password.' });
                            return done(null, user);
                            } catch (err) {
                            return done(err);
                            }
                            }
                            ));

                            // Google Strategy
                            if (process.env.GOOGLE_CLIENT_ID && process.env.GOOGLE_CLIENT_SECRET) {
                            passport.use(new GoogleStrategy({
                            clientID: process.env.GOOGLE_CLIENT_ID,
                            clientSecret: process.env.GOOGLE_CLIENT_SECRET,
                            callbackURL: "/api/auth/google/callback"
                            },
                            async (accessToken, refreshToken, profile, done) => {
                            try {
                            <% if (database==='mongodb' ) { %>
                                let user = await User.findOne({ googleId: profile.id });
                                <% } else { %>
                                    let user = await User.findByEmail(profile.emails?.[0].value || '');
                                    <% } %>

                                        if (!user) {
                                        user = await User.create({
                                        googleId: profile.id,
                                        email: profile.emails?.[0].value || '',
                                        name: profile.displayName,
                                        password: ''
                                        });
                                        }
                                        return done(null, user);
                                        } catch (err) {
                                        return done(err, null);
                                        }
                                        }));
                                        }

                                        // GitHub Strategy
                                        if (process.env.GITHUB_CLIENT_ID && process.env.GITHUB_CLIENT_SECRET) {
                                        passport.use(new GitHubStrategy({
                                        clientID: process.env.GITHUB_CLIENT_ID,
                                        clientSecret: process.env.GITHUB_CLIENT_SECRET,
                                        callbackURL: "/api/auth/github/callback"
                                        },
                                        async (accessToken, refreshToken, profile, done) => {
                                        try {
                                        <% if (database==='mongodb' ) { %>
                                            let user = await User.findOne({ githubId: profile.id });
                                            <% } else { %>
                                                let user = await User.findByEmail(profile.emails?.[0].value || '');
                                                <% } %>

                                                    if (!user) {
                                                    user = await User.create({
                                                    githubId: profile.id,
                                                    email: profile.emails?.[0].value || '',
                                                    name: profile.displayName || profile.username,
                                                    password: ''
                                                    });
                                                    }
                                                    return done(null, user);
                                                    } catch (err) {
                                                    return done(err, null);
                                                    }
                                                    }));
                                                    }
                                                    };
                                                    <% } %>